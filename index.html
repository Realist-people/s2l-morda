<!DOCTYPE html>
<html lang="ru-RU">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2.0">
      <title>S2L</title>
      <meta name="description" content="a silly simple short links generator" />
      <link rel="icon" href="favicon.avif">
      <style>
         .margin {
            margin: 0.67em auto;
         }
      </style>
      <link href="css/bootstrap.min.css" rel="stylesheet">
   </head>
   <body>
      <label for="link">
         <h1>Compress your link</h1>
      </label>
      <form>
         <input type="text" id="link">
         <br>
         <button type="button" class="margin btn btn-primary">Compress</button>
         <br>
         <output></output>
      </form>
      <div id="qrcode_holder"></div>
      <script src="js/qrcode.min.js"></script>
      <script>
         const input = document.querySelector('input');
         const btn = document.querySelector('button');
         const output = document.querySelector('output');
         const qrcodeHolder = document.getElementById('qrcode_holder');

         const inputWidth = parseInt( getComputedStyle(input).width );

         const qrCodeOptions = {
            quality: 0.5,
         };

         btn.addEventListener('click', () => {
            qrcodeHolder.innerHTML = '';
            output.textContent = '';
            btn.disabled = true;

            let link = input.value;
            if ( !(link.includes('://')) ) {
               link = 'http://' + link;
            }

            fetch(location.origin + '/compress', {
               method: 'POST',
               body: JSON.stringify({link})
            })
               .then((res) => res.json())
               .then((result) => {
                  output.textContent = result.link;

                  QRCode.toDataURL(result.link, qrCodeOptions, (err, encodedImg) => {
                     if (err !== null) {
                        console.warn(`can't create a qr-code:`);
                        console.warn(warn);
                     }
                     else {
                        const img = document.createElement('img');
                        img.src = encodedImg;
                        img.alt = 'QR-code with a compressed link';
                        img.width = inputWidth;
                        img.height = inputWidth;
                        qrcodeHolder.append(img);
                     }
                  });
               })
               .catch((err) => output.textContent = err.message)
               .finally(() => btn.disabled = false);
         });
      </script>
   </body>
</html>